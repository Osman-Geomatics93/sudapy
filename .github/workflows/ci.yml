name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install ruff
      - run: ruff check src/ tests/

  test:
    needs: lint
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.9", "3.11", "3.12"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package with core + dev extras
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest --tb=short -v

  test-geo:
    needs: lint
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v4

      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: latest
          environment-name: sudapy-geo
          create-args: >-
            python=3.11
            geopandas>=0.14
            shapely>=2.0
            fiona>=1.9
            pyproj>=3.6
            rasterio>=1.3
            pandas>=2.0
            numpy>=1.24
            scipy>=1.10
            gdal>=3.6
            -c conda-forge

      - name: Install SudaPy with all extras
        run: pip install -e ".[all,dev]"

      - name: Run tests
        run: pytest --tb=short -v

  build-wheel:
    needs: [test, test-geo]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build sdist and wheel
        run: python -m build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  build-windows-bundle:
    needs: [test, test-geo]
    runs-on: windows-latest
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v4

      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: latest
          environment-name: sudapy-bundle
          create-args: >-
            python=3.11
            geopandas>=0.14
            shapely>=2.0
            fiona>=1.9
            pyproj>=3.6
            rasterio>=1.3
            pandas>=2.0
            numpy>=1.24
            scipy>=1.10
            matplotlib>=3.7
            folium>=0.15
            contextily>=1.4
            gdal>=3.6
            conda-pack
            -c conda-forge

      - name: Install SudaPy and pip-only deps into conda env
        run: |
          pip install "typer[all]>=0.9" "rich>=13.0" "pyyaml>=6.0" "geographiclib>=2.0"
          pip install "earthpy>=0.9" "sentinelsat>=1.2"
          pip install --no-deps .

      - name: Pack conda environment
        shell: cmd /C call {0}
        run: conda-pack -n sudapy-bundle -o sudapy_env.tar.gz --ignore-editable-packages

      - name: Create bundle directory
        shell: cmd /C call {0}
        run: |
          mkdir SudaPy-Windows-x64\scripts\sudapy_env
          tar -xzf sudapy_env.tar.gz -C SudaPy-Windows-x64\scripts\sudapy_env

      - name: Run conda-unpack
        shell: cmd /C call {0}
        run: call SudaPy-Windows-x64\scripts\sudapy_env\Scripts\conda-unpack.exe

      - name: Copy bundle files
        shell: cmd /C call {0}
        run: |
          copy scripts\run_sudapy.bat SudaPy-Windows-x64\scripts\
          copy scripts\sudapy_doctor.bat SudaPy-Windows-x64\scripts\
          copy scripts\README_BUNDLE.txt SudaPy-Windows-x64\
          copy LICENSE SudaPy-Windows-x64\

      - name: Create zip archive
        shell: pwsh
        run: Compress-Archive -Path SudaPy-Windows-x64 -DestinationPath SudaPy-Windows-x64.zip

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle
          path: SudaPy-Windows-x64.zip

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-wheel, build-windows-bundle]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "SudaPy ${{ github.ref_name }}" \
            --generate-notes \
            artifacts/dist/*.whl \
            artifacts/dist/*.tar.gz \
            artifacts/windows-bundle/SudaPy-Windows-x64.zip

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          pip install twine
          twine upload artifacts/dist/*
